var z=Object.defineProperty;var C=(r,n,e)=>n in r?z(r,n,{enumerable:!0,configurable:!0,writable:!0,value:e}):r[n]=e;var d=(r,n,e)=>(C(r,typeof n!="symbol"?n+"":n,e),e);import"./modulepreload-polyfill-3cfb730f.js";import{g as T}from"./lil-gui.module.min-a1e98589.js";import{V as i,w as M,ac as W,y as I,z as R,t as X,F,W as j,H as K,I as B,J as O,G as Z,g as V,S as G,i as Y,T as q,b as Q,m as H,a as D,aW as N,aX as U}from"./mapSource-aa63c091.js";import{T as y,e as v}from"./tween.module-e5a426a4.js";import{c as J,f as $,d as ee,b as te,s as oe}from"./util-20863b21.js";const h=new W(0,0,0,"YXZ"),u=new i,ne={type:"change"},re={type:"lock"},ae={type:"unlock"},S=Math.PI/2;class se extends M{constructor(n,e){super(),this.camera=n,this.domElement=e,this.isLocked=!1,this.minPolarAngle=0,this.maxPolarAngle=Math.PI,this.pointerSpeed=1,this._onMouseMove=ie.bind(this),this._onPointerlockChange=ce.bind(this),this._onPointerlockError=de.bind(this),this.connect()}connect(){this.domElement.ownerDocument.addEventListener("mousemove",this._onMouseMove),this.domElement.ownerDocument.addEventListener("pointerlockchange",this._onPointerlockChange),this.domElement.ownerDocument.addEventListener("pointerlockerror",this._onPointerlockError)}disconnect(){this.domElement.ownerDocument.removeEventListener("mousemove",this._onMouseMove),this.domElement.ownerDocument.removeEventListener("pointerlockchange",this._onPointerlockChange),this.domElement.ownerDocument.removeEventListener("pointerlockerror",this._onPointerlockError)}dispose(){this.disconnect()}getObject(){return this.camera}getDirection(n){return n.set(0,0,-1).applyQuaternion(this.camera.quaternion)}moveForward(n){const e=this.camera;u.setFromMatrixColumn(e.matrix,0),u.crossVectors(e.up,u),e.position.addScaledVector(u,n)}moveRight(n){const e=this.camera;u.setFromMatrixColumn(e.matrix,0),e.position.addScaledVector(u,n)}lock(){this.domElement.requestPointerLock()}unlock(){this.domElement.ownerDocument.exitPointerLock()}}function ie(r){if(this.isLocked===!1)return;const n=r.movementX||r.mozMovementX||r.webkitMovementX||0,e=r.movementY||r.mozMovementY||r.webkitMovementY||0,t=this.camera;h.setFromQuaternion(t.quaternion),h.y-=n*.002*this.pointerSpeed,h.x-=e*.002*this.pointerSpeed,h.x=Math.max(S-this.maxPolarAngle,Math.min(S-this.minPolarAngle,h.x)),t.quaternion.setFromEuler(h),this.dispatchEvent(ne)}function ce(){this.domElement.ownerDocument.pointerLockElement===this.domElement?(this.dispatchEvent(re),this.isLocked=!0):(this.dispatchEvent(ae),this.isLocked=!1)}function de(){console.error("THREE.PointerLockControls: Unable to use Pointer Lock API")}let p=!1,f=!1,L=!1,b=!1,E=!1,_=performance.now();const c=new i,k=new i;class me extends M{constructor(e,t={centerPostion:new i(0,0,-3e3),cameraPosition:new i(0,3e4,0)}){super();d(this,"scene");d(this,"renderer");d(this,"camera");d(this,"controls");d(this,"ambLight");d(this,"dirLight");d(this,"container");d(this,"_clock",new I);d(this,"_autoForward",!1);d(this,"cameraZ",8);const a=typeof e=="string"?document.querySelector(e):e;if(a instanceof HTMLElement)this.container=a,this.renderer=this._createRenderer(),this.scene=this._createScene(),this.camera=this._createCamera(t.cameraPosition),this.controls=this._createControls(this.camera,this.container),this.ambLight=this._createAmbLight(),this.scene.add(this.ambLight),this.dirLight=this._createDirLight(t.centerPostion),this.scene.add(this.dirLight),this.container.appendChild(this.renderer.domElement),this.container.addEventListener("click",m=>{this.controls.isLocked?m.button===2&&this.controls.unlock():this.controls.lock()}),window.addEventListener("resize",this.resize.bind(this)),this.resize(),this.renderer.setAnimationLoop(this.animate.bind(this));else throw`${e} not found!}`}get autoForward(){return this._autoForward}set autoForward(e){p=e,this._autoForward=e}get width(){return this.container.clientWidth}get height(){return this.container.clientHeight}_createScene(){const e=new R,t=14414079;return e.background=new X(t),e.fog=new F(t,.003),e}_createRenderer(){const e=new j({antialias:!1,alpha:!0,logarithmicDepthBuffer:!0,precision:"highp"});return e.debug.checkShaderErrors=!0,e.sortObjects=!0,e.setPixelRatio(window.devicePixelRatio),e}_createCamera(e){const t=new K(70,1,.1,5e4);return t.position.copy(e),t}_createControls(e,t){const a=new se(e,t);a.minPolarAngle=Math.PI/2.2,a.maxPolarAngle=Math.PI;const m=function(w){switch(w.code){case"ArrowUp":case"KeyW":p=!0;break;case"ArrowLeft":case"KeyA":L=!0;break;case"ArrowDown":case"KeyS":f=!0;break;case"ArrowRight":case"KeyD":b=!0;break;case"Space":E&&(c.y+=350),E=!1;break}},l=function(w){switch(w.code){case"ArrowUp":case"KeyW":p=!1;break;case"ArrowLeft":case"KeyA":L=!1;break;case"ArrowDown":case"KeyS":f=!1;break;case"ArrowRight":case"KeyD":b=!1;break}};return document.addEventListener("keydown",m),document.addEventListener("keyup",l),a}_createAmbLight(){return new B(16777215,1)}_createDirLight(e){const t=new O(16777215,1);return t.position.set(0,2e3,1e3),t.target.position.copy(e),t}resize(){const e=this.width,t=this.height;return this.renderer.setPixelRatio(window.devicePixelRatio),this.renderer.setSize(e,t),this.camera.aspect=e/t,this.camera.updateProjectionMatrix(),this}animate(){const e=performance.now(),t=this.controls;if(t.isLocked===!0){p||(p=this.autoForward);const a=(e-_)/1e3;c.x-=c.x*10*a,c.z-=c.z*10*a,c.y-=9.8*300*a,k.z=Number(p)-Number(f),k.x=Number(b)-Number(L),k.normalize(),(p||f)&&(c.z-=k.z*this.cameraZ*5*a),(L||b)&&(c.x-=k.x*this.cameraZ*5*a),t.moveRight(-c.x*a),t.moveForward(-c.z*a),t.getObject().position.y+=c.y*a,t.getObject().position.y<this.cameraZ&&(c.y=0,t.getObject().position.y=this.cameraZ,E=!0)}_=e,this.renderer.render(this.scene,this.camera),this.dispatchEvent({type:"update",delta:this._clock.getDelta()})}}const o=J(D,H),le=o.localToWorld(o.geo2pos(new i(86,28,3))),he=o.localToWorld(o.geo2pos(new i(86.45,27.6,15))),s=new me("#map",{centerPostion:le,cameraPosition:he});s.scene.add(o);s.renderer.shadowMap.enabled=!0;o.receiveShadow=!0;o.viewerBufferSize=2;o.loadCacheSize=3e3;o.receiveShadow=!0;const A=new Z;o.add(A);const P=new V(new G,new Y({map:new q().load("../image/test.jpg"),transparent:!0}));P.castShadow=!0;P.receiveShadow=!0;s.container.addEventListener("click",r=>{if(!s.controls.isLocked||r.button!=0)return;const n=s.controls.getObject(),e=o.getLocalInfoFromScreen(n,new Q(0,0)),t=e?o.worldToLocal(e.point):o.worldToLocal(n.localToWorld(new i(0,0,-100))),a=P.clone();a.scale.setScalar(s.cameraZ/40),A.add(a);const m=o.worldToLocal(n.getWorldPosition(new i));a.position.copy(m);const l=1e3;new y(a.position).to({x:t.x,y:t.y},l).easing(v.Easing.Quadratic.Out).start(),new y(a.rotation).to({x:Math.PI,y:Math.PI,z:Math.PI},l).start(),new y(a.position).to({z:t.z},l).easing(e?v.Easing.Quadratic.In:v.Easing.Quartic.Out).start().onComplete(()=>{const x=()=>{a.removeFromParent(),a.geometry.dispose(),a.material.dispose()};e?setTimeout(x,10*l):x()});const w=n.position.clone();o.autoLoad=!1,n.position.sub(n.getWorldDirection(new i)),setTimeout(()=>{n.position.copy(w),o.autoLoad=!0},50)});s.addEventListener("update",()=>v.update());const g={mapbox:()=>{o.imgSource=D,o.reload()},google:()=>{o.imgSource=N,o.reload()},bing:()=>{o.imgSource=U,o.reload()},toXmly:()=>{const r=o.localToWorld(o.geo2pos(new i(86,28,15)));s.camera.position.copy(r)},toXian:()=>{const r=o.localToWorld(o.geo2pos(new i(109,34.7,8)));s.camera.position.copy(r)},toBeijing:()=>{const r=o.localToWorld(o.geo2pos(new i(116.4,40,10)));s.camera.position.copy(r)},toXiangGang:()=>{const r=o.localToWorld(o.geo2pos(new i(114.18,22.3,5)));s.camera.position.copy(r)}};(()=>{const r=new T,n=r.addFolder("环境");s.scene.fog instanceof F&&n.add(s.scene.fog,"density",1e-4,.1,1e-4).name("能见度系数"),n.add(s.ambLight,"intensity",.1,2,.1).name("环境光强度"),n.add(s.dirLight,"intensity",.1,2,.1).name("直射光强度");const e=r.addFolder("地图源");e.add(g,"mapbox"),e.add(g,"google").name("google(有偏移)"),e.add(g,"bing").name("bing(有偏移)");const t=r.addFolder("定位");t.add(g,"toXian").name("西安"),t.add(g,"toBeijing").name("北京"),t.add(g,"toXmly").name("喜马拉雅");const a=r.addFolder("控制");a.add(s,"cameraZ",0,10,.1).name("飞行海拔高度km").listen().onChange(m=>s.camera.position.setY(m)),a.add(s,"autoForward").name("自动前进")})();$(s);ee(o);te(o);oe(s,o);
