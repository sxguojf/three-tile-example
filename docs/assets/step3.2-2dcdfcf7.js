var v=Object.defineProperty;var f=(o,t,e)=>t in o?v(o,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):o[t]=e;var c=(o,t,e)=>(f(o,typeof t!="symbol"?t+"":t,e),e);import"./modulepreload-polyfill-3cfb730f.js";import{g}from"./lil-gui.module.min-a1e98589.js";import{a7 as S,V as r,a8 as p,E as b,v as y,w as L,s as k,F as w,W as E,y as P,z as x,H as _,ae as D,a as u,aX as V,aY as M,m as R}from"./mapSource-dadc50e7.js";import{e as K}from"./tween.module-26270d87.js";import{G as C}from"./GLTFLoader-df224738.js";import{c as F,f as A,d as z,b as U,s as W}from"./util-530f400c.js";const H={type:"change"},m=1e-6,l=new p;class T extends S{constructor(t,e=null){super(t,e),this.movementSpeed=1,this.rollSpeed=.005,this.dragToLook=!1,this.autoForward=!1,this._moveState={up:0,down:0,left:0,right:0,forward:0,back:0,pitchUp:0,pitchDown:0,yawLeft:0,yawRight:0,rollLeft:0,rollRight:0},this._moveVector=new r(0,0,0),this._rotationVector=new r(0,0,0),this._lastQuaternion=new p,this._lastPosition=new r,this._status=0,this._onKeyDown=X.bind(this),this._onKeyUp=Q.bind(this),this._onPointerMove=B.bind(this),this._onPointerDown=j.bind(this),this._onPointerUp=q.bind(this),this._onPointerCancel=G.bind(this),this._onContextMenu=I.bind(this),e!==null&&this.connect()}connect(){window.addEventListener("keydown",this._onKeyDown),window.addEventListener("keyup",this._onKeyUp),this.domElement.addEventListener("pointermove",this._onPointerMove),this.domElement.addEventListener("pointerdown",this._onPointerDown),this.domElement.addEventListener("pointerup",this._onPointerUp),this.domElement.addEventListener("pointercancel",this._onPointerCancel),this.domElement.addEventListener("contextmenu",this._onContextMenu)}disconnect(){window.removeEventListener("keydown",this._onKeyDown),window.removeEventListener("keyup",this._onKeyUp),this.domElement.removeEventListener("pointermove",this._onPointerMove),this.domElement.removeEventListener("pointerdown",this._onPointerDown),this.domElement.removeEventListener("pointerup",this._onPointerUp),this.domElement.removeEventListener("pointercancel",this._onPointerCancel),this.domElement.removeEventListener("contextmenu",this._onContextMenu)}dispose(){this.disconnect()}update(t){if(this.enabled===!1)return;const e=this.object,i=t*this.movementSpeed,s=t*this.rollSpeed;e.translateX(this._moveVector.x*i),e.translateY(this._moveVector.y*i),e.translateZ(this._moveVector.z*i),l.set(this._rotationVector.x*s,this._rotationVector.y*s,this._rotationVector.z*s,1).normalize(),e.quaternion.multiply(l),(this._lastPosition.distanceToSquared(e.position)>m||8*(1-this._lastQuaternion.dot(e.quaternion))>m)&&(this.dispatchEvent(H),this._lastQuaternion.copy(e.quaternion),this._lastPosition.copy(e.position))}_updateMovementVector(){const t=this._moveState.forward||this.autoForward&&!this._moveState.back?1:0;this._moveVector.x=-this._moveState.left+this._moveState.right,this._moveVector.y=-this._moveState.down+this._moveState.up,this._moveVector.z=-t+this._moveState.back}_updateRotationVector(){this._rotationVector.x=-this._moveState.pitchDown+this._moveState.pitchUp,this._rotationVector.y=-this._moveState.yawRight+this._moveState.yawLeft,this._rotationVector.z=-this._moveState.rollRight+this._moveState.rollLeft}_getContainerDimensions(){return this.domElement!=document?{size:[this.domElement.offsetWidth,this.domElement.offsetHeight],offset:[this.domElement.offsetLeft,this.domElement.offsetTop]}:{size:[window.innerWidth,window.innerHeight],offset:[0,0]}}}function X(o){if(!(o.altKey||this.enabled===!1)){switch(o.code){case"ShiftLeft":case"ShiftRight":this.movementSpeedMultiplier=.1;break;case"KeyW":this._moveState.forward=1;break;case"KeyS":this._moveState.back=1;break;case"KeyA":this._moveState.left=1;break;case"KeyD":this._moveState.right=1;break;case"KeyR":this._moveState.up=1;break;case"KeyF":this._moveState.down=1;break;case"ArrowUp":this._moveState.pitchUp=1;break;case"ArrowDown":this._moveState.pitchDown=1;break;case"ArrowLeft":this._moveState.yawLeft=1;break;case"ArrowRight":this._moveState.yawRight=1;break;case"KeyQ":this._moveState.rollLeft=1;break;case"KeyE":this._moveState.rollRight=1;break}this._updateMovementVector(),this._updateRotationVector()}}function Q(o){if(this.enabled!==!1){switch(o.code){case"ShiftLeft":case"ShiftRight":this.movementSpeedMultiplier=1;break;case"KeyW":this._moveState.forward=0;break;case"KeyS":this._moveState.back=0;break;case"KeyA":this._moveState.left=0;break;case"KeyD":this._moveState.right=0;break;case"KeyR":this._moveState.up=0;break;case"KeyF":this._moveState.down=0;break;case"ArrowUp":this._moveState.pitchUp=0;break;case"ArrowDown":this._moveState.pitchDown=0;break;case"ArrowLeft":this._moveState.yawLeft=0;break;case"ArrowRight":this._moveState.yawRight=0;break;case"KeyQ":this._moveState.rollLeft=0;break;case"KeyE":this._moveState.rollRight=0;break}this._updateMovementVector(),this._updateRotationVector()}}function j(o){if(this.enabled!==!1)if(this.dragToLook)this._status++;else{switch(o.button){case 0:this._moveState.forward=1;break;case 2:this._moveState.back=1;break}this._updateMovementVector()}}function B(o){if(this.enabled!==!1&&(!this.dragToLook||this._status>0)){const t=this._getContainerDimensions(),e=t.size[0]/2,i=t.size[1]/2;this._moveState.yawLeft=-(o.pageX-t.offset[0]-e)/e,this._moveState.pitchDown=(o.pageY-t.offset[1]-i)/i,this._updateRotationVector()}}function q(o){if(this.enabled!==!1){if(this.dragToLook)this._status--,this._moveState.yawLeft=this._moveState.pitchDown=0;else{switch(o.button){case 0:this._moveState.forward=0;break;case 2:this._moveState.back=0;break}this._updateMovementVector()}this._updateRotationVector()}}function G(){this.enabled!==!1&&(this.dragToLook?(this._status=0,this._moveState.yawLeft=this._moveState.pitchDown=0):(this._moveState.forward=0,this._moveState.back=0,this._updateMovementVector()),this._updateRotationVector())}function I(o){this.enabled!==!1&&o.preventDefault()}class Y extends b{constructor(e,i={centerPostion:new r(0,0,-3e3),cameraPosition:new r(0,3e4,0)}){super();c(this,"scene");c(this,"renderer");c(this,"camera");c(this,"controls");c(this,"ambLight");c(this,"dirLight");c(this,"container");c(this,"_clock",new y);const s=typeof e=="string"?document.querySelector(e):e;if(s instanceof HTMLElement)this.container=s,this.renderer=this._createRenderer(),this.scene=this._createScene(),this.camera=this._createCamera(i.cameraPosition),this.controls=this._createControls(),this.ambLight=this._createAmbLight(),this.scene.add(this.ambLight),this.dirLight=this._createDirLight(i.centerPostion),this.scene.add(this.dirLight),this.container.appendChild(this.renderer.domElement),window.addEventListener("resize",this.resize.bind(this)),this.resize(),this.renderer.setAnimationLoop(this.animate.bind(this));else throw`${e} not found!}`}get width(){return this.container.clientWidth}get height(){return this.container.clientHeight}_createScene(){const e=new L,i=14414079;return e.background=new k(i),e.fog=new w(i,.003),e}_createRenderer(){const e=new E({antialias:!1,alpha:!0,logarithmicDepthBuffer:!0,precision:"highp"});return e.debug.checkShaderErrors=!0,e.sortObjects=!0,e.setPixelRatio(window.devicePixelRatio),e}_createCamera(e){const i=new P(70,1,.1,5e4);return i.position.copy(e),i}_createControls(){const e=new T(this.camera,this.container);return e.domElement=this.container,e.autoForward=!1,e.movementSpeed=2,e.rollSpeed=.05,e}_createAmbLight(){return new x(16777215,1)}_createDirLight(e){const i=new _(16777215,1);return i.position.set(0,2e3,1e3),i.target.position.copy(e),i}resize(){const e=this.width,i=this.height;return this.renderer.setPixelRatio(window.devicePixelRatio),this.renderer.setSize(e,i),this.camera.aspect=e/i,this.camera.updateProjectionMatrix(),this}animate(){const e=this._clock.getDelta();this.controls.update(e),this.renderer.render(this.scene,this.camera),this.dispatchEvent({type:"update",delta:e})}}const n=F(u,R),Z=n.geo2world(new r(86,28,3)),O=n.geo2world(new r(86.45,27.6,15)),a=new Y("#map",{centerPostion:Z,cameraPosition:O});a.scene.add(n);a.renderer.shadowMap.enabled=!0;n.receiveShadow=!0;const $=new C;$.loadAsync("../model/Flamingo.glb").then(o=>{const t=o.scene;t.scale.setScalar(.01),a.scene.add(t),t.traverse(e=>{e.receiveShadow=!0,e.castShadow=!0}),J(t),ee(t),N(o)});const J=o=>{const t=new _(16777215,1.5);t.target=o,t.position.set(-2,3,-10),t.castShadow=!0,t.shadow.camera.near=.1,t.shadow.camera.far=1e3,t.shadow.camera.left=-10,t.shadow.camera.right=10,t.shadow.camera.top=10,t.shadow.camera.bottom=-10,t.shadow.mapSize.setScalar(1024),o.add(t)},N=o=>{const t=o.scene,e=new D(t);e.clipAction(o.animations[0]).play(),a.addEventListener("update",s=>{t.position.set(0,-.5,-3),t.applyMatrix4(a.camera.matrixWorld);const h=n.getLocalInfoFromWorld(t.position);h&&(d.modelHeight=t.position.y-h.point.y),h&&d.modelHeight<=.2?(t.rotateZ(s.delta*Math.PI),a.controls.movementSpeed=0):i(s.delta),K.update()});const i=s=>{const h=new r(0,0,-10).applyMatrix4(a.camera.matrixWorld);t.lookAt(h),a.controls.movementSpeed=2,e.update(s)}},d={modelHeight:0,mapbox:()=>{n.imgSource=u,n.reload()},google:()=>{n.imgSource=V,n.reload()},bing:()=>{n.imgSource=M,n.reload()},toXmly:()=>{const o=n.geo2world(new r(86,28,15));a.camera.position.copy(o)},toXian:()=>{const o=n.geo2world(new r(109,34.7,8));a.camera.position.copy(o)},toBeijing:()=>{const o=n.geo2world(new r(116.4,40,10));a.camera.position.copy(o)},toXiangGang:()=>{const o=n.geo2world(new r(114.18,22.3,5));a.camera.position.copy(o)}},ee=o=>{const t=new g,e=t.addFolder("环境");a.scene.fog instanceof w&&e.add(a.scene.fog,"density",1e-4,.01,1e-5).name("能见度系数"),e.add(a.ambLight,"intensity",.1,2,.1).name("环境光强度");const i=t.addFolder("地图源");i.add(d,"mapbox"),i.add(d,"google").name("google(有偏移)"),i.add(d,"bing").name("bing(有偏移)");const s=t.addFolder("小鸟");s.add(o,"visible").name("显示"),s.add(a.controls,"autoForward").name("自动前进"),s.add(o.position,"y").listen().name("飞行海拔高度km"),s.add(d,"modelHeight").listen().name("飞行距地高度km");const h=t.addFolder("定位");h.add(d,"toXian").name("西安"),h.add(d,"toBeijing").name("北京"),h.add(d,"toXmly").name("喜马拉雅")};A(a);z(n);U(n);W(a,n);
